<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Projekt - Logowanie i Waluty</title>
    <style>
      /* Reset i podstawy */
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px auto;
        max-width: 600px;
        background: #f9fafb;
        color: #333;
      }
      h2,
      h3 {
        color: #2c3e50;
        margin-bottom: 15px;
      }

      /* Formularz logowania */
      label {
        display: block;
        margin-top: 15px;
        font-weight: 600;
      }
      input {
        padding: 10px;
        width: 100%;
        max-width: 100%;
        margin-top: 5px;
        border: 1.8px solid #ccc;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }
      input:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 8px rgba(52, 152, 219, 0.4);
      }

      /* Przyciski */
      button {
        margin-top: 15px;
        padding: 10px 20px;
        background-color: #3498db;
        border: none;
        color: white;
        font-weight: 600;
        font-size: 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #2980b9;
      }
      button:active {
        background-color: #1c5980;
      }

      /* Komunikaty */
      #message {
        margin-top: 15px;
        color: #27ae60;
        font-weight: 600;
      }
      #error {
        margin-top: 15px;
        color: #e74c3c;
        font-weight: 600;
      }

      /* Sekcja po zalogowaniu */
      #loggedSection {
        margin-top: 30px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      #loggedSection button {
        margin-right: 10px;
      }

      /* Lista zadań */
      #tasks ul {
        margin-top: 15px;
        padding-left: 20px;
      }
      #tasks li {
        padding: 6px 0;
        border-bottom: 1px solid #eee;
      }

      /* Tabela kursów */
      #exchangeRates {
        margin-top: 25px;
      }
      #exchangeRates table {
        border-collapse: collapse;
        width: 100%;
        max-width: 100%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      #exchangeRates th,
      #exchangeRates td {
        border: none;
        padding: 12px 15px;
        text-align: left;
      }
      #exchangeRates thead tr {
        background-color: #3498db;
        color: white;
        font-weight: 600;
      }
      #exchangeRates tbody tr:nth-child(even) {
        background-color: #f2f6fc;
      }
      #exchangeRates tbody tr:hover {
        background-color: #dbeeff;
      }

      /* Responsywność */
      @media (max-width: 480px) {
        body {
          margin: 10px;
        }
        button {
          width: 100%;
          margin-right: 0;
          margin-top: 10px;
        }
        #loggedSection button {
          display: block;
          width: 100%;
          margin-bottom: 10px;
        }
      }
    </style>
  </head>
  <body>
    <h2>Logowanie</h2>
    <label for="login">Login</label>
    <input type="text" id="login" />

    <label for="password">Hasło</label>
    <input type="password" id="password" />

    <button id="loginBtn">Zaloguj</button>

    <div id="message"></div>
    <div id="error"></div>

    <div id="loggedSection" style="display: none">
      <button id="getTasksBtn">Pobierz zadania (GET /api/tasks)</button>
      <button id="logoutBtn">Wyloguj</button>

      <div id="tasks"></div>

      <h3>Kursy walut (NBP)</h3>
      <div id="exchangeRates">
        <table>
          <thead>
            <tr>
              <th>Waluta</th>
              <th>Kod</th>
              <th>Kurs (PLN)</th>
            </tr>
          </thead>
          <tbody id="exchangeRatesBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const loginInput = document.getElementById("login");
      const passwordInput = document.getElementById("password");
      const loginBtn = document.getElementById("loginBtn");
      const messageDiv = document.getElementById("message");
      const errorDiv = document.getElementById("error");
      const loggedSection = document.getElementById("loggedSection");
      const logoutBtn = document.getElementById("logoutBtn");
      const getTasksBtn = document.getElementById("getTasksBtn");
      const tasksDiv = document.getElementById("tasks");
      const exchangeRatesBody = document.getElementById("exchangeRatesBody");

      function updateUIOnAuth() {
        const token = localStorage.getItem("token");
        if (token) {
          loggedSection.style.display = "block";
          loginBtn.style.display = "none";
          loginInput.style.display = "none";
          passwordInput.style.display = "none";
          messageDiv.textContent = "Zalogowano pomyślnie!";
          errorDiv.textContent = "";
          fetchExchangeRates(token);
        } else {
          loggedSection.style.display = "none";
          loginBtn.style.display = "inline-block";
          loginInput.style.display = "inline-block";
          passwordInput.style.display = "inline-block";
          messageDiv.textContent = "";
          errorDiv.textContent = "";
          tasksDiv.innerHTML = "";
          exchangeRatesBody.innerHTML = "";
        }
      }

      loginBtn.addEventListener("click", async () => {
        const login = loginInput.value.trim();
        const password = passwordInput.value;

        if (!login || !password) {
          errorDiv.textContent = "Wprowadź login i hasło.";
          return;
        }

        try {
          const res = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: login, password: password }),
          });

          if (!res.ok) {
            errorDiv.textContent = "Błąd logowania. Sprawdź dane.";
            return;
          }

          const data = await res.json();
          localStorage.setItem("token", data.token);
          updateUIOnAuth();
        } catch (err) {
          errorDiv.textContent = "Błąd połączenia z serwerem.";
        }
      });

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("token");
        updateUIOnAuth();
      });

      getTasksBtn.addEventListener("click", async () => {
        const token = localStorage.getItem("token");
        if (!token) {
          errorDiv.textContent = "Musisz być zalogowany.";
          return;
        }

        try {
          const res = await fetch("/api/tasks", {
            headers: { Authorization: "Bearer " + token },
          });

          if (!res.ok) {
            errorDiv.textContent = "Błąd pobierania zadań.";
            return;
          }

          const tasks = await res.json();
          if (tasks.length === 0) {
            tasksDiv.innerHTML = "<p>Brak zadań do wyświetlenia.</p>";
          } else {
            tasksDiv.innerHTML =
              "<ul>" +
              tasks.map((t) => `<li>${t.name}</li>`).join("") +
              "</ul>";
          }
        } catch (err) {
          errorDiv.textContent = "Błąd połączenia z serwerem.";
        }
      });

      async function fetchExchangeRates(token) {
        try {
          const res = await fetch("/ExchangeRates", {
            headers: { Authorization: "Bearer " + token },
          });

          if (!res.ok) {
            exchangeRatesBody.innerHTML =
              '<tr><td colspan="3">Błąd pobierania kursów walut.</td></tr>';
            return;
          }

          const rates = await res.json();

          if (rates.length === 0) {
            exchangeRatesBody.innerHTML =
              '<tr><td colspan="3">Brak danych o kursach.</td></tr>';
            return;
          }

          exchangeRatesBody.innerHTML = rates
            .map(
              (rate) => `
        <tr>
          <td>${rate.currency}</td>
          <td>${rate.code}</td>
          <td>${rate.mid.toFixed(4)}</td>
        </tr>
      `
            )
            .join("");
        } catch {
          exchangeRatesBody.innerHTML =
            '<tr><td colspan="3">Błąd połączenia z serwerem.</td></tr>';
        }
      }

      updateUIOnAuth();
    </script>
  </body>
</html>
